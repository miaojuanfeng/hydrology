<!doctype html>
<html class="no-js">

	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="description" content="">
		<meta name="keywords" content="">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<title>来自朋友的邀请</title>

		<!-- Set render engine for 360 browser -->
		<meta name="renderer" content="webkit">

		<!-- No Baidu Siteapp-->
		<meta http-equiv="Cache-Control" content="no-siteapp" />

		<!-- Add to homescreen for Chrome on Android -->
		<meta name="mobile-web-app-capable" content="yes">

		<!-- Add to homescreen for Safari on iOS -->
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<meta name="apple-mobile-web-app-title" content="Amaze UI" />

		<!-- Tile icon for Win8 (144x144 + tile color) -->
		<meta name="msapplication-TileImage" content="assets/i/app-icon72x72@2x.png">
		<meta name="msapplication-TileColor" content="#0e90d2">

		<link rel="stylesheet" href="./css/amazeui.min.css">
		<link rel="stylesheet" href="./css/index.css">
		<script>
			var html = document.querySelector('html');
			changeRem();
			window.addEventListener('resize', changeRem);

			function changeRem() {
				var width = html.getBoundingClientRect().width;
				html.style.fontSize = width / 37.5 + 'px';
			}
		</script>
	</head>

	<body>
		<!--在这里编写你的代码-->
		<div id="app">
			<header>
				<img src="img/logo.png" alt="链活logo" class="logo" />
				<div class="logoTitle">
					<p>上链活</p>
					<p>采活力果免费购物</p>
				</div>
			</header>
			<div id="content">
				<div>
					<img src="img/qrcode_for_gh_1d22516e9a61_430.jpg" alt="用户头像" class="headImg" />
				</div>
				<div>
					<p class="tips">Hi,&nbsp;&nbsp;我入驻链活啦！</p>
				</div>
				<div class="formBox">
					<img src="img/10dian.png" alt="10点贡献值" class="dian10" />
					<div class="tips2">
						<p>一起来采活力果上活力商城免费购物啦！</p>
					</div>
					<div style="padding-top:4.5rem;">
						<div style="display: flex;" class="inputBox">
							<input type="text" class="input input_phone" placeholder="请输入手机号" id="phone" />
							<div class="input_btn_box">
								<input type="button" value="获取验证码" class="input_btn" id="phoneCode" />
							</div>

						</div>
						<div class="inputBox">
							<input type="text" class="input input_Keycode" placeholder="请输入短信验证码" id="keyCode" />
						</div>
						<div class="inputBox">
							<input type="text" class="input input_password" placeholder="请设置登录密码" id="passWord" />
						</div>
						<div>
							<img src="img/zhuceBtn.png" alt="" class="zhuceBtn" id="zhuceBtn" />
						</div>
					</div>
				</div>
				<div>
					<p style="font-size:1.4rem;line-height:2.5rem;color:#fff;text-align: center;">
						入驻步骤：完成注册-下载链活APP-登录APP
					</p>
				</div>
			</div>

			<div class="am-modal am-modal-alert" tabindex="-1" id="my-alert">
				<div class="am-modal-dialog">
					<div class="am-modal-bd" style="font-size:1.6rem;">

					</div>
				</div>
			</div>
			<img src="img/caidai_1.png" alt="彩带1" class="caidai" />
			<img src="img/caidai_2.png" alt="彩带2" class="caidai_2" />
			<img src="img/caidai_3.png" alt="彩带3" class="caidai_3" />
			<img src="img/caidai_4.png" alt="彩带4" class="caidai_4" />
			<img src="img/caidai_5.png" alt="彩带5" class="caidai_5" />
			<img src="img/caidai_6.png" alt="彩带6" class="caidai_6" />
		</div>
		<!--[if (gte IE 9)|!(IE)]><!-->
		<script src="./js/jquery.min.js"></script>
		<!--<![endif]-->
		<!--[if lte IE 8 ]>
			<script src="http://libs.baidu.com/jquery/1.11.3/jquery.min.js"></script>
			<script src="http://cdn.staticfile.org/modernizr/2.8.3/modernizr.js"></script>
		<![endif]-->
		<!--<script src="../javascripts/md5.js"></script>-->
		<script src="./js/amazeui.min.js"></script>
		<script src="https://cdn.bootcss.com/jsencrypt/3.0.0-beta.1/jsencrypt.min.js"></script>
		<script src="./js/sha1.min.js"></script>
		<script type="text/javascript">
			
//			let publicKey = 'MIHfMA0GCSqGSIb3DQEBAQUAA4HNADCByQKBwQCTC2VHkWEs1BrnFalIJoYH0Qh0NufwQkVyLIw3L695kblAHok5LlYABdHCsxmzJfoUiY+wN40V1PJMQh2nRnRWGKs8AwxCx1fQAb+nMkfIqOzgsDb5dFGAkZ9LQvIgzkRZTIf3KG9Ya7lpvk79Pv2/prxGLT8HawuAHH+nfaBDhOzmTjqXVDZ34pKKyO5nC3BEEIaEXbGOMLP7KSmZkAGg72/mczDxHPXX9UNMp0K5m9dEsjcrqXiXGGzlxTrSoJECAwEAAQ=='
			$('body').height($('body')[0].clientHeight);
			let headImg,inviteCode;
			let timer = null;
			$(function() {
				UrlSearch();
				getNodeTime();
				$("#phoneCode").on('click', function() {
					sendCode();
				})

				$("#zhuceBtn").on('click', function() {
					register();
				})
				var sign = SHA2('123456789');
				console.log(sign)
			})

			function UrlSearch() {
				var name, value;
				var str = location.href;
				var num = str.indexOf("?");
				var urlValue = [];
				str = str.substr(num + 1);

				var arr = str.split("&");

				for(var i = 0; i < arr.length; i++) {
					num = arr[i].indexOf("=");
					if(num > 0) {
						name = arr[i].substring(0, num);
						value = arr[i].substr(num + 1);
						this[name] = value;
						urlValue.push(value);

					}
				}

				headImg = urlValue[0];
				inviteCode = urlValue[1];
				
				$('.headImg').attr('src',headImg);
			}
			
			function getNodeTime(){
				$.ajax({
					type: "post",
					url: "/VTB_CHAIN/api/user/getTime",
					async: false,
					success:function(data){
						
						if(data.code == 200){
							//存入缓存
							localStorage.setItem('sysTime',data.data.sysTime);
							//获取本机时间
							var timeSelf = new Date().getTime();
							
							localStorage.setItem('timeSelf',timeSelf);
						}else {
							localStorage.setItem('sysTime',null);
							//获取本机时间
							var timeSelf = new Date().getTime();
							
							localStorage.setItem('timeSelf',timeSelf);
						}
					},
					error:function(error){						
						
						localStorage.setItem('sysTime',null);
						//获取本机时间
						var timeSelf = new Date().getTime();
						
						localStorage.setItem('timeSelf',timeSelf);
					}
				})	
					
			}
			function sendCode() {

				//获取手机号
				let phone = $('#phone').val();
				//验证手机
				if(!(/^1(3|4|5|6|7|8)\d{9}$/.test(phone)) || phone == "") {
					$(".am-modal-bd").html('手机号格式错误');
					$('#my-alert').modal();

					setTimeout(function() {
						$('#my-alert').modal('close');
					}, 1000);
					return false;
				}
				clearInterval(timer); //这句话至关重要
				var time = 60;
				var that = $('#phoneCode'); //习惯
				timer = setInterval(function() {
					console.log(time)
					if(time <= 0) {
						that.val('');
						that.val("获取验证码");
						that.disabled = false;

					} else {
						that.val('');
						that.val(time + '秒');
						that.disabled = true;
						time--;
					}
				}, 1000);
				//计算时间
				if(localStorage.getItem('sysTime') ==null){
					$(".am-modal-bd").html('系统错误');
					$('#my-alert').modal();

					setTimeout(function() {
						$('#my-alert').modal('close');
					}, 1500);
				}
				var sysTime = parseInt(localStorage.getItem('sysTime'));
				var timeSelf = parseInt(localStorage.getItem('timeSelf'));
				var nowTime = new Date().getTime();
				//计算差值
				var timeLast = nowTime - timeSelf;
				var timeSendCode = timeLast + sysTime;
				console.log(timeSendCode);
				//签名
				var sign = SHA2('/VTB_CHAIN/api/user/getSmsCode'+ timeSendCode)
				//var sign = SHA2('123456789');
				console.log(sign)
				
				$.ajax({
					type: "post",
					url: "/VTB_CHAIN/api/user/getSmsCode",
					async: false,
					data: {
						phoneNumber: phone,
						type: -1
					},
					headers:{
						stm:timeSendCode,
						sign:sign
					},
					success: function(data) {
						console.log(data);
						if(data.code == 200) {
							$(".am-modal-bd").html(data.msg);
							$('#my-alert').modal();

							setTimeout(function() {
								$('#my-alert').modal('close');
							}, 1000);

						} else {
							$(".am-modal-bd").html(data.msg);
							$('#my-alert').modal();

							setTimeout(function() {
								$('#my-alert').modal('close');
							}, 1500);
						}
					},
					error: function(error) {
						console.log(error);
						$(".am-modal-bd").html('服务器错误');
						$('#my-alert').modal();

						setTimeout(function() {
							$('#my-alert').modal('close');
						}, 1000);
					}
				});

			}

			//注册
			function register() {

				//获取手机号
				let phone = $('#phone').val();
				//验证手机
				if(!(/^1(3|4|5|6|7|8)\d{9}$/.test(phone)) || phone == "") {
					$(".am-modal-bd").html('手机号格式错误');
					$('#my-alert').modal();

					setTimeout(function() {
						$('#my-alert').modal('close');
					}, 1000);
					return false;
				}

				//获取密码
				let passWord = $('#passWord').val();

				//验证密码
				if(passWord == "") {
					$(".am-modal-bd").html('请输入密码');
					$('#my-alert').modal();

					setTimeout(function() {
						$('#my-alert').modal('close');
					}, 1000);
					return false;
				}

				//获取验证码
				let keyCode = $('#keyCode').val();

				//验证验证码
				if(keyCode == "") {
					$(".am-modal-bd").html('请输入验证码');
					$('#my-alert').modal();

					setTimeout(function() {
						$('#my-alert').modal('close');
					}, 1000);
					return false;
				}
				
				//计算时间
				if(localStorage.getItem('sysTime') ==null){
					$(".am-modal-bd").html('系统错误');
					$('#my-alert').modal();

					setTimeout(function() {
						$('#my-alert').modal('close');
					}, 1500);
				}
				var sysTime = parseInt(localStorage.getItem('sysTime'));
				var timeSelf = parseInt(localStorage.getItem('timeSelf'));
				var nowTime = new Date().getTime();
				//计算差值
				var timeLast = nowTime - timeSelf;
				var timeStamp = timeLast + sysTime;

				//签名
				var sign = SHA2('/VTB_CHAIN/api/user/htm/register'+ timeStamp)
				//var sign = SHA2('123456789');
				console.log(sign)
				//rsa加密
				const key = "MIHfMA0GCSqGSIb3DQEBAQUAA4HNADCByQKBwQCTC2VHkWEs1BrnFalIJoYH0Qh0NufwQkVyLIw3L695kblAHok5LlYABdHCsxmzJfoUiY+wN40V1PJMQh2nRnRWGKs8AwxCx1fQAb+nMkfIqOzgsDb5dFGAkZ9LQvIgzkRZTIf3KG9Ya7lpvk79Pv2/prxGLT8HawuAHH+nfaBDhOzmTjqXVDZ34pKKyO5nC3BEEIaEXbGOMLP7KSmZkAGg72/mczDxHPXX9UNMp0K5m9dEsjcrqXiXGGzlxTrSoJECAwEAAQ==";
				let encrypt = new JSEncrypt();
				encrypt.setPublicKey(key);
				var jsonMsg = {
					'passWord':passWord
				};

				let encryptKey = encrypt.encrypt(JSON.stringify(jsonMsg));
				
				console.log(encryptKey)
								
				$.ajax({
					type: "post",
					url: "/VTB_CHAIN/api/user/htm/register",
					async: false,
					data: {
						phoneNumber: phone,
						smsCode: keyCode,
						data: encryptKey,
						inviteCode: inviteCode
					},
					headers: {
						stm: timeStamp,
						sign: sign
					},
					success: function(data) {
						if(data.code == 200) {
							$(".am-modal-bd").html(data.msg);
							$('#my-alert').modal();

							setTimeout(function() {
								$('#my-alert').modal('close');
								//跳转下载
								window.location.href = "https://lh.saintenjoy.com/download"
							}, 1500);

						} else {
							var d = JSON.parse(data);							
							$(".am-modal-bd").html(d.msg);
							$('#my-alert').modal();
							setTimeout(function() {
								$('#my-alert').modal('close');
								//跳转下载
								//window.location.href = "https://lh.saintenjoy.com/download"
							}, 1500);

						}
					},
					error: function(error) {
						$(".am-modal-bd").html('服务器错误');
						$('#my-alert').modal();

						setTimeout(function() {
							$('#my-alert').modal('close');
						}, 1000);
					}
				});
			}
		</script>
	</body>

</html>